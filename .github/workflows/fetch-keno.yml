name: Auto Fetch Keno Result

on:
  schedule:
    - cron: "* * * * *"   # mỗi 1 phút
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Keno data from API
        run: |
          mkdir -p data

          API_URL="https://veso247.vn:19901/api/keno/result/keno?page_size=50&page_index=1"

          echo "Fetching API..."
          curl -s "$API_URL" > data/new.json

          # lấy drawCode mới nhất từ API
          NEW_DRAW=$(jq -r '.data.items[0].drawCode' data/new.json)

          if [ "$NEW_DRAW" = "null" ] || [ -z "$NEW_DRAW" ]; then
            echo "API error or empty data"
            exit 0
          fi

          echo "New drawCode: $NEW_DRAW"

          # nếu chưa có latest.json thì init
          if [ ! -f data/latest.json ]; then
            echo "Init latest.json"
            cp data/new.json data/latest.json
            echo '{"last_update":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > data/meta.json
            echo "[]" > data/history.json
          fi

          OLD_DRAW=$(jq -r '.data.items[0].drawCode' data/latest.json)

          echo "Old drawCode: $OLD_DRAW"

          # nếu có kỳ mới
          if [ "$NEW_DRAW" != "$OLD_DRAW" ]; then
            echo "New draw detected → updating"

            # cập nhật latest
            cp data/new.json data/latest.json

            # append lịch sử (chỉ thêm những draw chưa có)
            jq -s '
              (.[0] // []) as $old
              | .[1].data.items
              | map(select(.drawCode as $d | ($old | map(.drawCode) | index($d)) | not))
              | . + $old
            ' data/history.json data/new.json > data/history_tmp.json

            mv data/history_tmp.json data/history.json

            # update meta
            jq -n \
              --arg draw "$NEW_DRAW" \
              --arg time "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              '{last_draw:$draw,last_update:$time}' > data/meta.json

          else
            echo "No new draw"
          fi

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add data

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update keno result"
            git push
          fi
