name: Auto Fetch Keno Result

on:
  schedule:
    - cron: "*/1 * * * *"
  workflow_dispatch:

concurrency:
  group: keno-fetch
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch API
        run: |
          mkdir -p data
          curl -s "https://veso247.vn:19901/api/keno/result/keno?page_size=10&page_index=1" > data/latest.json

      - name: Validate & Commit
        run: |
          node <<'EOF'
          const fs = require("fs");

          const file = "data/latest.json";
          const data = JSON.parse(fs.readFileSync(file,"utf8"));

          if (!data?.data?.items?.length) {
            console.log("Invalid API data");
            process.exit(0);
          }

          const draw = data.data.items[0].drawCode;
          const meta = { draw, updatedAt: new Date().toISOString() };
          fs.writeFileSync("data/meta.json", JSON.stringify(meta, null, 2));

          console.log("Latest draw:", draw);
          EOF

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git pull origin main --rebase || true
          git add data/latest.json data/meta.json
          git commit -m "Auto update keno draw" || exit 0
          git push
