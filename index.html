<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Keno â€“ Thá»‘ng kÃª Hot / Cold</title>

<style>
:root{
  --cell-width:75px;
  --cell-height:55px;
  --font-btn:18px;
  --font-cell:22px;
}
body{
  font-family: Arial, sans-serif;
  margin:0;
  padding:15px;
  text-align:center;
}
button{ font-size:18px; padding:6px 16px; margin:6px; }
#info{ font-size:22px; font-weight:bold; margin:10px 0; }
#board{ margin:0 auto; border-collapse:collapse; }
#board td{
  width:75px; height:55px; border:1px solid #aaa;
  font-size:22px; text-align:center;
}
#board td:nth-child(5){ border-right:3px solid #000; }
#board tr:nth-child(4) td{ border-bottom:3px solid #000; }

.hit{ background:#4caf50; color:#fff; }
.prev-hit{ text-decoration: underline; text-decoration-thickness:3px; }
.hot1{ color:#ffcc80; font-weight:bold; }
.hot2{ color:#ff9800; font-weight:bold; }
.hot3{ color:#e65100; font-weight:bold; }
.cold1{ color:#90caf9; }
.cold2{ color:#1e88e5; font-weight:bold; }
.cold3{ color:#0d47a1; font-weight:bold; }
</style>
</head>

<body>

<h2>Keno â€“ Thá»‘ng kÃª Hot / Cold (10 ká»³)</h2>
<div id="info"></div>

<button onclick="newer()">â—€</button>
<button onclick="older()">â–¶</button>

<table id="board"></table>

<script>
let results = [];
let index = 0;
const WINDOW = 10;
let lastApiFetch = 0;
const API_COOLDOWN = 60000;

/* ===== LOAD GITHUB ===== */
async function loadFromGithub(){
  const res = await fetch("data/latest.json?t=" + Date.now());
  const json = await res.json();
  return json.data.items.map(it => ({
    draw: parseInt(it.drawCode,10),
    date: it.openDate.split(" ")[0],
    nums: Array.from({length:20},(_,i)=>+it["num"+(i+1)])
  }));
}

/* ===== FETCH API BÃ™ ===== */
async function fetchApiIfNeeded(latestDraw){
  if(Date.now() - lastApiFetch < API_COOLDOWN) return [];
  lastApiFetch = Date.now();

  const res = await fetch(
    "https://veso247.vn:19901/api/keno/result/keno?page_size=30&page_index=1",
    { cache:"no-store" }
  );
  const json = await res.json();

  return json.data.items
    .map(it => ({
      draw: parseInt(it.drawCode,10),
      date: it.openDate.split(" ")[0],
      nums: Array.from({length:20},(_,i)=>+it["num"+(i+1)])
    }))
    .filter(it => it.draw > latestDraw);
}

/* ===== INIT ===== */
async function init(){
  const gh = await loadFromGithub();
  const newest = gh[0]?.draw || 0;
  const api = await fetchApiIfNeeded(newest);
  results = [...api, ...gh];
  render();
}

/* ===== STATS ===== */
function calcStats(){
  let freq = Array(81).fill(0);
  let drought = Array(81).fill(0);
  const end = Math.min(results.length, index+WINDOW);
  const slice = results.slice(index,end);

  slice.forEach(r=>r.nums.forEach(n=>freq[n]++));
  for(let n=1;n<=80;n++){
    for(let i=index;i<end;i++){
      if(results[i].nums.includes(n)) break;
      drought[n]++;
    }
  }
  return {freq,drought};
}

/* ===== RENDER ===== */
function render(){
  if(!results.length) return;
  const cur = results[index];
  const prev = results[index+1]?.nums || [];
  const {freq,drought} = calcStats();

  document.getElementById("info").innerText =
    `NgÃ y ${cur.date} â€“ Ká»³ #${cur.draw}`;

  const tb = document.getElementById("board");
  tb.innerHTML = "";
  let n=1;

  for(let r=0;r<8;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<10;c++){
      let td=document.createElement("td");
      td.textContent=n.toString().padStart(2,"0");

      if(cur.nums.includes(n)) td.classList.add("hit");
      if(prev.includes(n)) td.classList.add("prev-hit");

      if(freq[n]>=7) td.classList.add("hot3");
      else if(freq[n]>=5) td.classList.add("hot2");
      else if(freq[n]===4) td.classList.add("hot1");

      if(drought[n]>=8) td.classList.add("cold3");
      else if(drought[n]>=6) td.classList.add("cold2");
      else if(drought[n]>=4) td.classList.add("cold1");

      tr.appendChild(td); n++;
    }
    tb.appendChild(tr);
  }
}

function older(){ if(index+1<results.length){ index++; render(); } }
function newer(){ if(index>0){ index--; render(); } }

/* ===== AUTO CHECK Ká»² Má»šI (TV) ===== */
let lastKnownDraw = null;

async function getLatestDrawFromAPI(){
  try{
    const res = await fetch(
      "https://veso247.vn:19901/api/keno/result/keno?page_size=1&page_index=1",
      { cache:"no-store" }
    );
    const js = await res.json();
    return parseInt(js.data.items[0].drawCode,10);
  }catch(e){ return null; }
}

setInterval(async ()=>{
  if(!results.length) return;
  if(lastKnownDraw === null) lastKnownDraw = results[0].draw;

  const latest = await getLatestDrawFromAPI();
  if(latest && latest > lastKnownDraw){
    console.log("ðŸ”„ CÃ³ ká»³ má»›i â†’ reload");
    location.reload();
  }
}, 30000);

init();
</script>

</body>
</html>
