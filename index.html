<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Keno â€“ Thá»‘ng kÃª Hot / Cold</title>

<style>
:root{
  --cell-width:75px;
  --cell-height:55px;
  --font-btn:18px;
  --font-cell:22px;
}
body{
  font-family: Arial, sans-serif;
  background:#fff;
  margin:0;
  padding:15px;
  text-align:center;
}
h2{ margin-bottom:6px; }
button{
  font-size:var(--font-btn);
  padding:8px 18px;
  margin:6px;
  cursor:pointer;
  border-radius:6px;
}
#info{
  font-size:22px;
  font-weight:bold;
  margin:10px 0;
}
.nav{ margin-bottom:10px; }
#board{
  margin:0 auto;
  border-collapse:collapse;
}
#board td{
  width:var(--cell-width);
  height:var(--cell-height);
  border:1px solid #aaa;
  font-size:var(--font-cell);
  text-align:center;
}
#board td:nth-child(5){ border-right:3px solid #000; }
#board tr:nth-child(4) td{ border-bottom:3px solid #000; }

.hit{ background:#4caf50; color:#fff; }
.prev-hit{
  text-decoration: underline;
  text-decoration-thickness: 3px;
  text-underline-offset: 6px;
}

.hot1{ color:#ffcc80; font-weight:bold; }
.hot2{ color:#ff9800; font-weight:bold; }
.hot3{ color:#e65100; font-weight:bold; }

.cold1{ color:#90caf9; }
.cold2{ color:#1e88e5; font-weight:bold; }
.cold3{ color:#0d47a1; font-weight:bold; }

.note{
  max-width:1200px;
  margin:20px auto;
  font-size:16px;
  line-height:1.6;
  text-align:left;
}
.note-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:12px;
}
.note-grid > div{
  background:#fafafa;
  padding:10px 12px;
  border-radius:6px;
}
.note-title{ grid-column:1 / -1; }
.note-footer{
  grid-column:1 / -1;
  text-align:center;
  color:#555;
}
</style>
</head>

<body>

<h2>Keno â€“ Thá»‘ng kÃª Hot / Cold (10 ká»³ gáº§n nháº¥t)</h2>
<div id="info"></div>

<div class="nav">
  <button onclick="newer()">â—€</button>
  <button onclick="older()">â–¶</button>
</div>

<table id="board"></table>

<div class="note note-grid">
  <div class="note-title"><b>Giáº£i thÃ­ch cho khÃ¡ch xem:</b></div>
  <div>
    ğŸŸ¢ <b>Ná»n xanh lÃ¡</b>: sá»‘ trÃºng ká»³ Ä‘ang xem<br>
    â–¬ <b>Gáº¡ch chÃ¢n</b>: sá»‘ trÃºng ká»³ liá»n trÆ°á»›c
  </div>
  <div>
    ğŸ”¥ <b>HOT</b> (10 ká»³):<br>
    â€¢ 7â€“10 láº§n: cam Ä‘áº­m<br>
    â€¢ 5â€“6 láº§n: cam<br>
    â€¢ 4 láº§n: cam nháº¡t
  </div>
  <div>
    â„ <b>COLD</b> (gan):<br>
    â€¢ â‰¥8 ká»³: xanh Ä‘áº­m<br>
    â€¢ 6â€“7 ká»³: xanh<br>
    â€¢ 4â€“5 ká»³: xanh nháº¡t
  </div>
  <div class="note-footer">
    <i>Thá»‘ng kÃª mang tÃ­nh tham kháº£o.</i>
  </div>
</div>

<script>
let results = [];
let index = 0;
const WINDOW = 10;
let lastApiFetch = 0;
const API_COOLDOWN = 60 * 1000;

/* ===== LOAD GITHUB DATA ===== */
async function loadFromGithub(){
  const res = await fetch("data/latest.json?t=" + Date.now());
  const json = await res.json();

  return json.data.items.map(it => ({
    draw: it.drawCode,
    date: it.openDate.split(" ")[0],
    time: it.openDate,
    nums: Array.from({length:20},(_,i)=>parseInt(it["num"+(i+1)],10))
  }));
}

/* ===== FETCH API BÃ™ Ká»² ===== */
async function fetchApiIfNeeded(latestDraw){
  if(Date.now() - lastApiFetch < API_COOLDOWN) return [];
  lastApiFetch = Date.now();

  const res = await fetch(
    "https://veso247.vn:19901/api/keno/result/keno?page_size=30&page_index=1"
  );
  const json = await res.json();

  const apiItems = json.data.items.map(it => ({
    draw: it.drawCode,
    date: it.openDate.split(" ")[0],
    time: it.openDate,
    nums: Array.from({length:20},(_,i)=>parseInt(it["num"+(i+1)],10))
  }));

  return apiItems.filter(it => it.draw > latestDraw);
}

/* ===== INIT ===== */
async function init(){
  const gh = await loadFromGithub();
  const newestDraw = gh[0]?.draw || "0";

  const apiNew = await fetchApiIfNeeded(newestDraw);

  results = [...apiNew, ...gh];
  render();
}

/* ===== STATS ===== */
function calcStats(){
  let freq = Array(81).fill(0);
  let drought = Array(81).fill(0);

  const end = Math.min(results.length, index + WINDOW);
  const slice = results.slice(index, end);

  slice.forEach(r => r.nums.forEach(n => freq[n]++));
  for(let n=1;n<=80;n++){
    for(let i=index;i<end;i++){
      if(results[i].nums.includes(n)) break;
      drought[n]++;
    }
  }
  return {freq,drought};
}

/* ===== RENDER ===== */
function render(){
  if(!results.length) return;

  const cur = results[index];
  const prev = results[index+1]?.nums || [];
  const {freq,drought} = calcStats();

  document.getElementById("info").innerText =
    `NgÃ y ${cur.date} â€“ Ká»³ #${cur.draw}`;

  const tb = document.getElementById("board");
  tb.innerHTML = "";

  let n = 1;
  for(let r=0;r<8;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<10;c++){
      let td=document.createElement("td");
      td.textContent=n.toString().padStart(2,"0");

      if(cur.nums.includes(n)) td.classList.add("hit");
      if(prev.includes(n)) td.classList.add("prev-hit");

      if(freq[n]>=7) td.classList.add("hot3");
      else if(freq[n]>=5) td.classList.add("hot2");
      else if(freq[n]===4) td.classList.add("hot1");

      if(drought[n]>=8) td.classList.add("cold3");
      else if(drought[n]>=6) td.classList.add("cold2");
      else if(drought[n]>=4) td.classList.add("cold1");

      tr.appendChild(td);
      n++;
    }
    tb.appendChild(tr);
  }
}

function older(){ if(index+1<results.length){ index++; render(); } }
function newer(){ if(index>0){ index--; render(); } }

init();
</script>

</body>
</html>
